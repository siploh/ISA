<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Admin Bad Stok</title>
<style>
body{font-family:'Segoe UI', sans-serif;margin:0;padding:0;background:#f3f4f6;}
header{background:#16a34a;color:white;padding:15px 20px;text-align:center;}
.container{max-width:1200px;margin:20px auto;padding:0 15px;}
.cards{display:flex;flex-wrap:wrap;gap:15px;}
.card{background:white;flex:1;min-width:200px;padding:15px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.1);text-align:center;}
.card h3{margin:10px 0 0;color:#16a34a;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
table th, table td{border:1px solid #d1d5db;padding:8px;text-align:center;}
table th{background-color:#16a34a;color:white;}
.filter-container{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;}
.filter-container input, .filter-container select, .filter-container button{padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px;cursor:pointer;}
@media(max-width:768px){.cards{flex-direction:column;}table{font-size:12px;}}
button{background:#16a34a;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;}
button:hover{background:#15803d;}
</style>
</head>
<body>

<header><h1>Dashboard Admin Bad Stok</h1></header>
<div class="container">

<div class="cards">
<div class="card"><h2 id="totalToko">0</h2><h3>Total Toko</h3></div>
<div class="card"><h2 id="totalBarang">0</h2><h3>Total Barang</h3></div>
<div class="card"><h2 id="totalNilai">0</h2><h3>Total Nilai Bad Stok</h3></div>
</div>

<div class="filter-container">
<input type="date" id="filterTanggalDari">
<input type="date" id="filterTanggalSampai">
<select id="filterInvoice"><option value="">Semua Invoice</option></select>
<button onclick="renderTable()">Filter</button>
</div>

<table id="badStokTable">
<thead>
<tr>
<th>No</th>
<th>Tanggal Input</th>
<th>NoInvoice</th>
<th>Toko</th>
<th>Barang</th>
<th>Jumlah</th>
<th>Harga</th>
<th>Total</th>
<th>Aksi</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>
const scriptURL="https://script.google.com/macros/s/AKfycbydxwdYiSxkOf2hxC5XAfgrTpGNFYPu9uGWV999QZQKaovKXReNrdRDcmw4eGsCckNf/exec"; 
let badStokData=[], invoices=[];

// FORMAT TANGGAL DD-MM-YYYY
function formatTanggal(tgl){
    if(!tgl) return '-';
    const d=new Date(tgl);
    return d.toLocaleDateString('id-ID',{
        day:'2-digit',
        month:'2-digit',
        year:'numeric'
    });
}

// FORMAT ANGKA RIBUAN
function formatRupiah(angka){
    if(!angka) return '0';
    return Number(angka).toLocaleString('id-ID');
}

function parseTanggal(r){
    return new Date(r.tanggalInput||r.tanggal||0);
}

async function loadData(){
    const res=await fetch(scriptURL);
    const data=await res.json();
    badStokData=data.badStok||[];
    invoices=[...new Set(badStokData.map(r=>r.noInvoice))];

    // ===== SUMMARY BERDASARKAN INPUTAN BAD STOK =====
    const tokoUnik=[...new Set(badStokData.map(r=>r.namaToko))];
    const barangUnik=[...new Set(badStokData.map(r=>r.namaBarang))];

    document.getElementById('totalToko').textContent=tokoUnik.length;
    document.getElementById('totalBarang').textContent=barangUnik.length;

    const totalNilai=badStokData.reduce((sum,r)=>sum+Number(r.total),0);
    document.getElementById('totalNilai').textContent=formatRupiah(totalNilai);

    // FILTER INVOICE
    const invoiceSelect=document.getElementById('filterInvoice');
    invoiceSelect.innerHTML='<option value="">Semua Invoice</option>';
    invoices.forEach(i=>invoiceSelect.appendChild(new Option(i,i)));

    renderTable();
}

function renderTable(){
    const tbody=document.querySelector("#badStokTable tbody");
    tbody.innerHTML='';

    const tanggalDari=document.getElementById('filterTanggalDari').value;
    const tanggalSampai=document.getElementById('filterTanggalSampai').value;
    const invoiceFilter=document.getElementById('filterInvoice').value;

    let filteredData=badStokData.filter(r=>{
        const tgl=parseTanggal(r);
        const dari=!tanggalDari||tgl>=new Date(tanggalDari);
        const sampai=!tanggalSampai||tgl<=new Date(tanggalSampai+"T23:59:59");
        return dari && sampai && (!invoiceFilter||r.noInvoice===invoiceFilter);
    });

    filteredData.sort((a,b)=>b.noInvoice.localeCompare(a.noInvoice,undefined,{numeric:true}));

    let no=1;
    filteredData.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
            <td>${no}</td>
            <td>${formatTanggal(r.tanggalInput||r.tanggal)}</td>
            <td>${r.noInvoice}</td>
            <td>${r.namaToko}</td>
            <td>${r.namaBarang}</td>
            <td style="text-align:right;">${formatRupiah(r.jumlahBarang)}</td>
            <td style="text-align:right;">${formatRupiah(r.harga)}</td>
            <td style="text-align:right;">${formatRupiah(r.total)}</td>
            <td><button onclick="printInvoice('${r.noInvoice}')">Cetak</button></td>
        `;
        tbody.appendChild(tr);
        no++;
    });
}

function printInvoice(invoiceNo){
    const invoiceFilter=invoiceNo||document.getElementById('filterInvoice').value;
    if(!invoiceFilter)return alert("Pilih nomor invoice terlebih dahulu!");
    const printData=badStokData.filter(r=>r.noInvoice===invoiceFilter);
    if(printData.length===0)return alert("Data invoice tidak ditemukan.");

    let w=window.open();
    w.document.write('<h2>Invoice No: '+invoiceFilter+'</h2>');
    w.document.write('<table border="1" cellpadding="5" cellspacing="0" style="border-collapse:collapse;width:100%;">');
    w.document.write('<tr><th>No</th><th>Barang</th><th style="text-align:right;">Jumlah</th><th style="text-align:right;">Harga</th><th style="text-align:right;">Total</th></tr>');
    printData.forEach((r,i)=>{
        w.document.write('<tr><td>'+(i+1)+'</td><td>'+r.namaBarang+'</td><td style="text-align:right;">'+formatRupiah(r.jumlahBarang)+'</td><td style="text-align:right;">'+formatRupiah(r.harga)+'</td><td style="text-align:right;">'+formatRupiah(r.total)+'</td></tr>');
    });
    const totalInvoice=printData.reduce((sum,r)=>sum+Number(r.total),0);
    w.document.write('<tr><td colspan="4" style="text-align:right;"><strong>Total</strong></td><td style="text-align:right;">'+formatRupiah(totalInvoice)+'</td></tr>');
    w.document.write('</table>');
    w.print();
}

loadData();
</script>

</body>
</html>
